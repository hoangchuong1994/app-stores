generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  MODERATOR
  USER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

enum ProductStatus {
  DRAFT
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

enum CouponType {
  PERCENTAGE
  AMOUNT
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum ActivityType {
  LOGIN
  LOGOUT
  CREATE
  UPDATE
  DELETE
}

enum StockChangeReason {
  PURCHASE
  RETURN
  MANUAL_ADJUST
  RESERVATION
  RELEASE
  TRANSFER
}

enum ShipmentStatus {
  CREATED
  PICKED
  IN_TRANSIT
  DELIVERED
  RETURNED
  CANCELLED
}

// --------------------------------------------------
// AUTH MODELS (NextAuth compatible)
// --------------------------------------------------

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation("UserAccounts", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation("UserSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
  @@map("verification_tokens")
}

// --------------------------------------------------
// USER, AUTH, ADDRESS
// --------------------------------------------------

model User {
  id                   String     @id @default(cuid())
  name                 String?
  email                String?    @unique
  phone                String?    @unique
  emailVerified        DateTime?
  password             String?
  image                String?
  role                 UserRole   @default(USER)
  status               UserStatus @default(ACTIVE)
  lastLoginAt          DateTime?
  lastPasswordChangeAt DateTime?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  deletedAt            DateTime?
  deletedById          String?

  // relations
  accounts        Account[]     @relation("UserAccounts")
  sessions        Session[]     @relation("UserSessions")
  orders          Order[]
  addresses       Address[]
  activityLogs    ActivityLog[]
  cartItems       CartItem[]
  reviews         Review[]
  products        Product[]     @relation("UserProducts")
  updatedProducts Product[]     @relation("UserUpdatedProducts")
  couponUsages    CouponUsage[]

  @@index([role])
  @@index([status])
  @@map("users")
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  fullName  String
  phone     String
  street    String
  city      String
  state     String
  country   String
  zipCode   String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id])
  orders Order[]

  @@index([userId])
}

// --------------------------------------------------
// ACTIVITY LOG
// --------------------------------------------------

model ActivityLog {
  id         String       @id @default(cuid())
  userId     String?
  action     String
  actionType ActivityType
  ip         String?
  userAgent  String?
  createdAt  DateTime     @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
}

// --------------------------------------------------
// CATEGORY & TRANSLATIONS
// --------------------------------------------------

model Category {
  id           String                @id @default(cuid())
  parentId     String?
  parent       Category?             @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children     Category[]            @relation("CategoryHierarchy")
  name         String
  slug         String                @unique
  translations CategoryTranslation[]
  products     Product[]
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  deletedAt    DateTime?

  @@index([parentId])
  @@index([deletedAt])
}

model CategoryTranslation {
  id         String   @id @default(cuid())
  categoryId String
  language   String
  name       String
  category   Category @relation(fields: [categoryId], references: [id])

  @@unique([categoryId, language])
}

// --------------------------------------------------
// PRODUCT & VARIANTS & ATTRIBUTES
// --------------------------------------------------

model Product {
  id           String        @id @default(cuid())
  name         String
  title        String
  slug         String        @unique
  sku          String        @unique
  description  String        @db.Text
  price        Decimal       @db.Decimal(10, 2)
  baseDiscount Decimal       @default(0) @db.Decimal(10, 2)
  status       ProductStatus @default(DRAFT)
  thumbnail    String
  origin       String?

  metaTitle       String
  metaDescription String @db.Text

  isFeatured Boolean @default(false)
  isNew      Boolean @default(false)

  minPrice  Decimal? @db.Decimal(10, 2)
  maxPrice  Decimal? @db.Decimal(10, 2)
  available Boolean  @default(true)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  trademarkId String?
  trademark   Trademark? @relation(fields: [trademarkId], references: [id])

  images       ProductImage[]
  variants     ProductVariant[]
  promotions   ProductPromotion[]
  orderItems   OrderItem[]
  reviews      Review[]
  translations ProductTranslation[]
  attributes   ProductAttribute[]

  createdById String
  updatedById String?
  createdBy   User    @relation("UserProducts", fields: [createdById], references: [id])
  updatedBy   User?   @relation("UserUpdatedProducts", fields: [updatedById], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([price])
  @@index([createdAt])
  @@index([categoryId, status, available, price])
  @@index([deletedAt])
}

model ProductTranslation {
  id              String  @id @default(cuid())
  productId       String
  language        String
  name            String
  title           String?
  description     String?
  metaTitle       String?
  metaDescription String?
  product         Product @relation(fields: [productId], references: [id])

  @@unique([productId, language])
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  sku       String  @unique
  slug      String? @unique
  price     Decimal @db.Decimal(10, 2)
  available Boolean @default(false)

  colorId String?
  sizeId  String?

  product Product @relation(fields: [productId], references: [id])
  color   Color?  @relation(fields: [colorId], references: [id])
  size    Size?   @relation(fields: [sizeId], references: [id])

  images       VariantImage[]
  inventory    Inventory[]
  orderItems   OrderItem[]
  cartItems    CartItem[]
  stockHistory StockHistory[]
  reserved     ReservedStock[]

  @@index([productId])
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String
  alt       String?

  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
}

model VariantImage {
  id        String  @id @default(cuid())
  variantId String
  url       String
  isPrimary Boolean @default(false)
  order     Int?

  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@index([variantId])
  @@index([variantId, order])
}

model ProductAttribute {
  id        String @id @default(cuid())
  productId String
  key       String
  value     String

  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
}

// --------------------------------------------------
// INVENTORY
// --------------------------------------------------

model Warehouse {
  id           String          @id @default(cuid())
  name         String          @unique
  location     String
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  inventory    Inventory[]
  stockHistory StockHistory[]
  reserved     ReservedStock[]
}

model Inventory {
  id          String   @id @default(cuid())
  variantId   String
  warehouseId String
  quantity    Int      @default(0)
  price       Decimal? @db.Decimal(10, 2)
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  warehouse Warehouse      @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([variantId, warehouseId])
  @@index([warehouseId])
}

model ReservedStock {
  id          String    @id @default(cuid())
  variantId   String
  warehouseId String
  orderId     String
  quantity    Int
  reservedAt  DateTime  @default(now())
  expiresAt   DateTime?

  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  warehouse Warehouse      @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  order     Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([variantId])
  @@index([orderId])
}

model StockHistory {
  id          String            @id @default(cuid())
  variantId   String
  warehouseId String
  change      Int
  reason      StockChangeReason
  note        String?
  createdAt   DateTime          @default(now())

  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  warehouse Warehouse      @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
}

// --------------------------------------------------
// ORDER, CART, REVIEW
// --------------------------------------------------

model Order {
  id            String      @id @default(cuid())
  userId        String
  status        OrderStatus @default(PENDING)
  subtotal      Decimal     @db.Decimal(10, 2)
  shippingFee   Decimal?    @db.Decimal(10, 2)
  discountTotal Decimal?    @db.Decimal(10, 2)
  taxTotal      Decimal?    @db.Decimal(10, 2)
  finalTotal    Decimal     @db.Decimal(10, 2)
  currency      String      @default("USD")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  addressId     String?

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  Address        Address?        @relation(fields: [addressId], references: [id], onDelete: SetNull)
  items          OrderItem[]
  payments       Payment[]
  shipments      Shipment[]
  couponUsages   CouponUsage[]
  orderHistories OrderHistory[]
  reservedStocks ReservedStock[]

  @@index([createdAt])
  @@index([userId, createdAt])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  variantId String
  productId String?

  quantity Int
  price    Decimal @db.Decimal(10, 2)

  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  product Product?       @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([orderId])
}

model CartItem {
  id        String @id @default(cuid())
  userId    String
  variantId String
  quantity  Int

  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  productId String
  rating    Int
  comment   String?  @db.Text
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// --------------------------------------------------
// PROMOTION & COUPON
// --------------------------------------------------

model Coupon {
  id         String     @id @default(cuid())
  code       String     @unique
  type       CouponType
  value      Decimal    @db.Decimal(10, 2)
  usageLimit Int?
  usedCount  Int        @default(0)
  startDate  DateTime
  endDate    DateTime
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  deletedAt  DateTime?

  usages CouponUsage[]

  @@index([startDate, endDate])
  @@index([deletedAt])
}

model CouponUsage {
  id       String   @id @default(cuid())
  couponId String
  userId   String
  orderId  String
  usedAt   DateTime @default(now())

  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([couponId])
  @@index([userId])
  @@index([orderId])
}

model Promotion {
  id               String             @id @default(cuid())
  name             String             @unique
  description      String             @db.Text
  startDate        DateTime
  endDate          DateTime
  minPurchase      Decimal?           @db.Decimal(10, 2)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  deletedAt        DateTime?
  ProductPromotion ProductPromotion[]

  @@index([startDate, endDate])
  @@index([deletedAt])
}

model ProductPromotion {
  productId   String
  promotionId String
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  promotion   Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@id([productId, promotionId])
}

// --------------------------------------------------
// SHIPPING & PAYMENT
// --------------------------------------------------

model Shipping {
  id            String    @id @default(cuid())
  name          String
  fee           Decimal   @db.Decimal(10, 2)
  estimatedDays Int
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  @@index([deletedAt])
}

model Shipment {
  id          String         @id @default(cuid())
  orderId     String
  carrier     String
  trackingNo  String?
  status      ShipmentStatus @default(CREATED)
  shippedAt   DateTime?
  deliveredAt DateTime?
  createdAt   DateTime       @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([trackingNo])
}

model Payment {
  id        String        @id @default(cuid())
  orderId   String
  amount    Decimal       @db.Decimal(10, 2)
  method    String
  status    PaymentStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  order Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  logs  PaymentLog[]

  @@index([orderId])
}

model PaymentLog {
  id        String   @id @default(cuid())
  paymentId String
  message   String   @db.Text
  createdAt DateTime @default(now())

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
}

// --------------------------------------------------
// COLOR, SIZE, TRADEMARK
// --------------------------------------------------

model Color {
  id       String           @id @default(cuid())
  name     String           @unique
  code     String           @unique
  variants ProductVariant[]
}

model Size {
  id       String           @id @default(cuid())
  name     String           @unique
  order    Int?
  variants ProductVariant[]
}

model Trademark {
  id        String    @id @default(cuid())
  name      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([deletedAt])
}

// --------------------------------------------------
// ORDER HISTORY
// --------------------------------------------------

model OrderHistory {
  id        String      @id @default(cuid())
  orderId   String
  status    OrderStatus
  note      String?
  createdAt DateTime    @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
}
